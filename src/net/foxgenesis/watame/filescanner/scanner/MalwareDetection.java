package net.foxgenesis.watame.filescanner.scanner;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import net.dv8tion.jda.api.entities.Message;
import net.dv8tion.jda.api.entities.Message.Attachment;
import net.foxgenesis.watame.filescanner.FileScannerPlugin;
import net.foxgenesis.watame.filescanner.scanner.AttachmentScanner.AttachmentException;

public class MalwareDetection implements AttachmentScanner {
	
	private static final Logger logger = LoggerFactory.getLogger("MalwareDetection");
	
    private final byte[] FOOTER = { (byte)0x00, (byte)0x00, (byte)0x00, (byte)0x00, (byte)0x49, (byte)0x45, (byte)0x4e, (byte)0x44, (byte)0xae, (byte)0x42, (byte)0x60, (byte)0x82};
    //java is fucking stupid and doesnt have unsigned bytes
    private final byte[] MAL_HINT = {0x6f, 0x62,  0x6a, 0x53, 0x68, 0x65, 0x6c, 0x6c, 0x2e, 0x45, 0x6e, 0x76, 0x69, 
                                        0x72, 0x6f, 0x6e, 0x6d, 0x65, 0x6e, 0x74, 0x28 };
    private final byte[] MAL_TEST = {0x58, 0x35, 0x4f, 0x21, 0x50, 0x25, 0x40, 0x41, 0x50, 0x5b, 0x34, 0x5c, 0x50, 0x5a, 0x58, 0x35, 0x34, 0x28, 0x50, 0x5e, 0x29, 0x37,
                                    0x43, 0x43, 0x29, 0x37, 0x7d, 0x24, 0x45, 0x49, 0x43, 0x41, 0x52, 0x2d, 0x53, 0x54, 0x41, 0x4e, 0x44, 0x41, 0x52, 0x44, 0x2d, 0x41,
                                    0x4e, 0x54, 0x49, 0x56, 0x49, 0x52, 0x55, 0x53, 0x2d, 0x54, 0x45, 0x53, 0x54, 0x2d, 0x46, 0x49, 0x4c, 0x45, 0x21, 0x24, 0x48, 0x2b,
                                    0x48, 0x2a};
	private enum malwareType {
		NONE,
		TEST,
		OBJSHELL
	};
	

	/**
	 * performs completable future test of contents of files for malware
	 * 
	 * @author Spaz-Master
	 * @param in			- bytes of file to test
	 * @param msg			- Message object of discord message
	 * @param  attachment	- Attachment object of the the file
	 */
	@Override
	public CompletableFuture<Void> testAttachment(byte[] in, Message msg, Attachment attachment) {

		return CompletableFuture.supplyAsync( () -> {
			int j = 0;
			int v = 0;
			malwareType type = malwareType.NONE;
			
			for(int i = 0; i< in.length; i++){

                if(in[i] == MAL_HINT[j]){
                    j++;
                    //i++;
                }else
                    j = 0;
                
                if(in[i] == MAL_TEST[v])
                    v++;
                else
                    v = 0;
            
            //stop++;
            if(j==MAL_HINT.length){
                type = malwareType.OBJSHELL;
                break;
            }
            if(v==MAL_TEST.length){
                type = malwareType.TEST;
                break;
            }
    
        }
			
			if(type != malwareType.NONE) {
				logger.debug("Detected malicious file: {}", type);
				AttachmentException ae = new AttachmentException(FileScannerPlugin.MALWARE_DETECTED);
				//TODO: send info about WHAT KIND of malware
				throw new CompletionException(ae);
			}
			return null;
			
		});
		
		//return CompletableFuture.completedFuture(null);
	}

}
